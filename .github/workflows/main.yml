on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - dev

name: "Build & Release"

jobs:
  build-android:
    name: Build & Test Android
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest release version
        id: get_version
        run: |
          # Get the latest tag or set to 0 if none exists
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          # Extract the version number (remove 'v' prefix)
          LATEST_VERSION=${LATEST_TAG#v}
          # Parse the version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
          # Increment the patch version
          NEW_PATCH=$((PATCH + 1))
          # Set the new version
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "TAG=v$NEW_VERSION" >> $GITHUB_ENV

      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: 'stable'
          architecture: x64

      # Decode Keystore file
      - name: Decode Keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/app/upload-keystore.jks

      # Create key.properties
      - name: Create key.properties
        run: |
          echo "storePassword=${{ secrets.KEY_STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=../app/upload-keystore.jks" >> android/key.properties

      # Set environment variables for reproducible builds
      - name: Set reproducible build parameters
        run: |
          # Set SOURCE_DATE_EPOCH to a fixed timestamp for reproducible builds
          echo "SOURCE_DATE_EPOCH=1577836800" >> $GITHUB_ENV
          # Tell ZIP to ignore timestamps
          echo "ZIPFLAGS=-X" >> $GITHUB_ENV

      # Run Flutter analyze to check for issues
      - name: Flutter Analyze
        run: flutter analyze

      # Run tests before building
      - name: Run Tests
        run: flutter test

      # Build APK for Android with reproducible parameters
      - name: Build APK
        run: |
          # Using --build-name with the version from our calculation
          flutter build apk --release --split-per-abi --build-name=${{ env.VERSION }}

          # Rename APKs with proper versioning
          cd build/app/outputs/apk/release
          mv app-armeabi-v7a-release.apk SysAdmin-v${{ env.VERSION }}-armeabi-v7a.apk
          mv app-arm64-v8a-release.apk SysAdmin-v${{ env.VERSION }}-arm64-v8a.apk
          mv app-x86_64-release.apk SysAdmin-v${{ env.VERSION }}-x86_64.apk

      - name: Upload Android Builds
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            build/app/outputs/apk/release/SysAdmin-v${{ env.VERSION }}-armeabi-v7a.apk
            build/app/outputs/apk/release/SysAdmin-v${{ env.VERSION }}-arm64-v8a.apk
            build/app/outputs/apk/release/SysAdmin-v${{ env.VERSION }}-x86_64.apk

  build-ios:
    name: Build & Test iOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest release version
        id: get_version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          LATEST_VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "TAG=v$NEW_VERSION" >> $GITHUB_ENV

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.29.2'
          channel: 'stable'

      - name: Build iOS App
        run: |
          flutter build ios --release --no-codesign --build-name=${{ env.VERSION }}
          cd build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -r SysAdmin-v${{ env.VERSION }}.ipa Payload

      - name: Upload iOS Build
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: build/ios/iphoneos/SysAdmin-v${{ env.VERSION }}.ipa

  release:
    name: Create Release
    needs: [build-android, build-ios]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version from build
        id: get_version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          LATEST_VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_VERSION"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
          echo "VERSION=$NEW_VERSION" >> $GITHUB_ENV
          echo "TAG=v$NEW_VERSION" >> $GITHUB_ENV

      - name: Download Android Builds
        uses: actions/download-artifact@v4
        with:
          name: android-builds
          path: artifacts

      - name: Download iOS Build
        uses: actions/download-artifact@v4
        with:
          name: ios-build
          path: artifacts

      - name: Push to Releases
        uses: ncipollo/release-action@v1
        with:
          artifacts: |
            artifacts/SysAdmin-v${{ env.VERSION }}-armeabi-v7a.apk
            artifacts/SysAdmin-v${{ env.VERSION }}-arm64-v8a.apk
            artifacts/SysAdmin-v${{ env.VERSION }}-x86_64.apk
            artifacts/SysAdmin-v${{ env.VERSION }}.ipa
          token: ${{ secrets.TOKEN }}
          tag: ${{ env.TAG }}
          name: SysAdmin ${{ env.TAG }}
          body: ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false