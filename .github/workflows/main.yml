name: "Build & Release"

on:
    pull_request:
        branches:
            - develop
    push:
        branches:
            - develop
    workflow_dispatch:
    release:
        types:
            - published

jobs:
    build:
        name: Build & Test
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-java@v3
              with:
                  distribution: "zulu"
                  java-version: "12"
            - uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  architecture: x64

            # Run Flutter analyze to ensure no issues in the code
            - name: Flutter Analyze
              run: flutter analyze

            # Run tests
            - name: Run Tests
              run: flutter test

            # Build APK for Android after successful tests
            - name: Build APK
              run: flutter build apk --release --split-per-abi

            # Build IPA for iOS after successful tests
            - name: Build IPA
              run: |
                  flutter build ios --no-codesign
                  cd build/ios/iphoneos
                  mkdir Payload
                  cd Payload
                  ln -s ../Runner.app
                  cd ..
                  zip -r app.ipa Payload

    release:
        name: Build and Release
        needs: build
        runs-on: macos-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-java@v3
              with:
                  distribution: "zulu"
                  java-version: "12"
            - uses: subosito/flutter-action@v2
              with:
                  channel: "stable"
                  architecture: x64

            # Re-run analyze and test before releasing
            - name: Flutter Analyze
              run: flutter analyze

            - name: Run Tests
              run: flutter test

            - name: Build APK
              run: flutter build apk --release --split-per-abi

            - name: Build IPA
              run: |
                  flutter build ios --no-codesign
                  cd build/ios/iphoneos
                  mkdir Payload
                  cd Payload
                  ln -s ../Runner.app
                  cd ..
                  zip -r app.ipa Payload

            - name: Push to Releases
              uses: ncipollo/release-action@v1
              with:
                  artifacts: "build/app/outputs/apk/release/*,build/ios/iphoneos/app.ipa"
                  tag: ${{ github.event.release.tag_name }}
                  token: ${{ secrets.TOKEN }}

    merge_to_main:
        name: Merge Release to Main
        runs-on: ubuntu-latest
        needs: release
        steps:
            - name: Checkout release branch
              run: |
                  git config user.name "github-actions"
                  git config user.email "github-actions@github.com"
                  git checkout main
                  git merge release
                  git push origin main
